# User Authentication and Registration gRPC Service Documentation

## Overview

This document describes the gRPC service for user registration and authentication. The service provides secure methods
for creating new user accounts and authenticating existing users.

## Service Definition

The service is defined in the `auth.proto` file and includes two main RPC methods:

1. `Register`: For creating new user accounts
2. `Authenticate`: For authenticating existing users

## Data Structures

### RegisterRequest

Used to send user registration data to the server.

| Field                    | Type                 | Description                                 |
|--------------------------|----------------------|---------------------------------------------|
| username                 | string               | User's chosen username                      |
| email                    | string               | User's email address                        |
| salt                     | bytes                | Random salt for key derivation              |
| public_identity_key      | bytes                | User's public identity key                  |
| public_signed_pre_key    | bytes                | User's public signed pre-key                |
| signed_pre_key_signature | bytes                | Signature of the signed pre-key             |
| public_one_time_pre_keys | repeated bytes       | List of public one-time pre-keys            |
| public_kyber_key         | bytes                | User's public Kyber key                     |
| encrypted_private_keys   | EncryptedPrivateKeys | Structure containing encrypted private keys |

### EncryptedPrivateKeys

Contains the user's encrypted private keys and associated metadata.

| Field                       | Type               | Description                                 |
|-----------------------------|--------------------|---------------------------------------------|
| encrypted_identity_key      | bytes              | Encrypted private identity key              |
| encrypted_signed_pre_key    | bytes              | Encrypted private signed pre-key            |
| encrypted_one_time_pre_keys | repeated bytes     | List of encrypted private one-time pre-keys |
| encrypted_kyber_key         | bytes              | Encrypted private Kyber key                 |
| key_metadata                | map<string, bytes> | Metadata associated with the keys           |

### RegisterResponse

Server response to a successful registration.

| Field   | Type   | Description                    |
|---------|--------|--------------------------------|
| user_id | string | Unique identifier for the user |

### AuthRequest

Initial request for user authentication.

| Field        | Type   | Description                      |
|--------------|--------|----------------------------------|
| username     | string | User's username                  |
| client_nonce | bytes  | Random nonce generated by client |

### AuthChallenge

Server's challenge in the authentication process.

| Field        | Type  | Description                      |
|--------------|-------|----------------------------------|
| salt         | bytes | User's salt (stored on server)   |
| server_nonce | bytes | Random nonce generated by server |

### AuthResponse

Client's response to the server's challenge.

| Field | Type  | Description                                        |
|-------|-------|----------------------------------------------------|
| hmac  | bytes | HMAC computed using derived key and challenge data |

### AuthResult

Final result of a successful authentication.

| Field                  | Type                 | Description                                      |
|------------------------|----------------------|--------------------------------------------------|
| access_token           | string               | Short-lived token for API access                 |
| refresh_token          | string               | Long-lived token for obtaining new access tokens |
| encrypted_private_keys | EncryptedPrivateKeys | User's encrypted private keys                    |

## Registration Process

1. Client prepares a `RegisterRequest` with all required fields.
2. Client sends the `RegisterRequest` to the server using the `Register` RPC method.
3. Server validates the request data.
4. If valid, server generates a unique `user_id` and stores the user's data securely.
5. Server responds with a `RegisterResponse` containing the `user_id`.

## Authentication Process

1. Client sends an `AuthRequest` with the username and a client-generated nonce.
2. Server responds with an `AuthChallenge` containing the user's salt and a server-generated nonce.
3. Client derives the encryption key using Argon2: